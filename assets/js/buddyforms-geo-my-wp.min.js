var fieldContainerExamples,bfGeoAddressFieldInstance={generateFieldId:function(){for(var e="",d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=0;t<5;t++)e+=d.charAt(Math.floor(Math.random()*d.length));return e},setFieldStatus:function(e,d){var t=jQuery(d).find("p.gmw-lf-field.message");if(0<t.length)switch(t.removeClass("error ok changed"),e){case"ok":t.addClass("ok");break;case"changed":t.addClass("changed");break;default:t.addClass("error")}},loadAutoComplete:function(n){var s=document.getElementById(n);if(null!=s&&"undefined"!=typeof google){var o=jQuery(s).closest(".container-for-geo-address-field").parent(),i=new google.maps.places.Autocomplete(s,{types:["geocode"]});google.maps.event.addListener(i,"place_changed",function(){bfGeoAddressFieldInstance.setFieldStatus("changed",o);var e=i.getPlace();if(e.geometry){var d=jQuery(s.closest("form")),t=d.find('[name="'+n+'_data"]').val(),a=t?JSON.parse(t):"",r={location:{}};r.location.lat=e.geometry.location.lat().toFixed(6),r.location.lng=e.geometry.location.lng().toFixed(6),r.address_components=e.address_components,r.formatted_address=e.formatted_address,r.icon=e.icon,r.url=e.url,r.place_id=e.place_id,r.location_id=a&&a.location_id?a.location_id:0,d.find('[name="'+n+'_data"]').val(JSON.stringify(r)),bfGeoAddressFieldInstance.setFieldStatus("ok",o)}else bfGeoAddressFieldInstance.setFieldStatus("error",o)}),jQuery(s).attr("attached","true")}else jQuery(".container-for-geo-address-controls").hide()},updateAddButtonClass:function(e){var a=jQuery(e).find(".bf-geo-address-fields.bf-address-autocomplete-active .container-for-geo-address-controls");jQuery.each(a,function(e,d){var t=jQuery(d).find(".geo-address-field-add");1<=a.length&&e+1!==a.length?t.hide():t.css("display","inline")})},addField:function(e,d,t,a){var r="",n="",s="error";a&&a.formatted_address&&(r=a.formatted_address,n=JSON.stringify(a),s="ok"),jQuery(e).removeClass("bf-geo-address-example"),jQuery(e).addClass("bf-address-autocomplete-active"),jQuery(e).find('input[type="text"]').attr("id",t),jQuery(e).find('input[type="text"]').attr("value",r),jQuery(e).find('input[type="text"]').removeAttr("attached"),jQuery(e).find('input[type="text"]').removeClass("bf-address-autocomplete-example"),jQuery(e).find('input[type="text"]').attr("name",t),jQuery(e).find('input[type="hidden"]').attr("value",n),jQuery(e).find('input[type="hidden"]').attr("name",t+"_data"),jQuery(e).find('input[type="hidden"]').attr("field_target",t),jQuery(e).find(".container-for-geo-address-controls .bfgmw-action a.geo-address-field-delete").attr("field_target",t),jQuery(e).find(".container-for-geo-address-controls p.gmw-lf-field.message").removeClass("error ok changed"),jQuery(e).find(".container-for-geo-address-controls p.gmw-lf-field.message").addClass(s),jQuery(e).find(".container-for-geo-address-controls p.bfgmw-action .geo-address-field-delete:visible").first().hide(),d.append(e),bfGeoAddressFieldInstance.updateAddButtonClass(d),bfGeoAddressFieldInstance.loadAutoComplete(t)},removeField:function(e,d){var t=jQuery(d).closest(".container-for-geo-address-controls").parent(),a=t.parent();t.hide().removeClass("bf-address-autocomplete-active");var r=jQuery(a).find(".bf-address-autocomplete-active"),n=jQuery(a).find('input[type="hidden"][name="'+e+'_data"]'),s=n.val();if(s&&((s=JSON.parse(s)).delete=s.location_id,n.val(JSON.stringify(s))),jQuery(a).find("#"+e).val()&&0===r.length){var o=jQuery(a).find(".bf-geo-address-example"),i=jQuery(a).find('.container-for-geo-address-field input[type="text"].bf-address-autocomplete-example').attr("name")+"_"+bfGeoAddressFieldInstance.generateFieldId();bfGeoAddressFieldInstance.addField(jQuery(o).clone(),jQuery(a),i)}bfGeoAddressFieldInstance.updateAddButtonClass(a)},actionAddField:function(){var e=jQuery(this).attr("field_name"),d=jQuery(this).closest(".bf-geo-address-fields").parent().find('.container-for-geo-address-field input[name="'+e+'"].bf-address-autocomplete-example').parent().parent(),t=e+"_"+bfGeoAddressFieldInstance.generateFieldId();bfGeoAddressFieldInstance.addField(d.clone(),d.parent(),t)},actionRemoveField:function(){var e=jQuery(this),d=e.attr("field_target");bfGeoAddressFieldInstance.removeField(d,e)},submitForm:function(){var e=jQuery('input[type="hidden"][name^="bf_"][name$="_count"]');0<e.length&&jQuery.each(e,function(e,d){var t=jQuery(d).attr("field_name"),a=jQuery('input[type="hidden"][name^="'+t+'_"][name$="_data"]');if(0<a.length){var r=[];jQuery.each(a,function(e,d){var t=jQuery(d).val(),a=jQuery(d).attr("field_target");t&&a&&r.push({field:a,data:JSON.parse(t)})}),0<r.length&&jQuery(d).val(JSON.stringify(r))}})},init:function(){var e=jQuery("form");0<(fieldContainerExamples=jQuery(".bf-geo-address-example")).length&&0<e.length&&(jQuery&&jQuery.validator&&jQuery.validator.addMethod("address-required",function(e,d){return!(!e||""===e)||(jQuery.validator.messages["address-required"]=buddyforms_geo_field.validation_error_message,!1)},""),jQuery.each(fieldContainerExamples,function(e,t){var d=jQuery(t).find('.container-for-geo-address-field input[type="text"].bf-address-autocomplete-example');if(d){var a=d.attr("name"),r=jQuery('input[type="hidden"][name="bf_'+a+'_count"]'),n=r.val();if(n&&(n=JSON.parse(r.val())),n)jQuery.each(n,function(e,d){d.field&&d.data&&bfGeoAddressFieldInstance.addField(jQuery(t).clone(),jQuery(t).parent(),d.field,d.data)});else{var s=a+"_"+bfGeoAddressFieldInstance.generateFieldId();bfGeoAddressFieldInstance.addField(jQuery(t).clone(),jQuery(t).parent(),s)}}}),e.on("click",".geo-address-field-add",bfGeoAddressFieldInstance.actionAddField),e.on("click",".geo-address-field-delete",bfGeoAddressFieldInstance.actionRemoveField),e.on("click",'button[type="submit"].bf-submit',bfGeoAddressFieldInstance.submitForm))}};jQuery(document).ready(function(){bfGeoAddressFieldInstance.init()});